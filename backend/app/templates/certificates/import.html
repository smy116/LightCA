{% extends "base.html" %}

{% block title %}导入证书 - LightCA{% endblock %}

{% block content %}
<section x-data="importCertPage()" class="space-y-4">
    <h1 class="text-3xl font-bold">导入证书</h1>
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body space-y-4">
            <div>
                <label class="label"><span class="label-text">证书 PEM</span></label>
                <textarea class="textarea textarea-bordered h-36 w-full font-mono" x-model="certPem"></textarea>
            </div>
            <div>
                <label class="label"><span class="label-text">私钥 PEM (可选)</span></label>
                <textarea class="textarea textarea-bordered h-36 w-full font-mono" x-model="keyPem"></textarea>
            </div>
            <div class="grid gap-3 md:grid-cols-2">
                <input class="input input-bordered" placeholder="密钥密码 (可选)" x-model="keyPassword" />
                <label class="label cursor-pointer justify-start gap-2">
                    <input type="checkbox" class="checkbox" x-model="rememberPassword" />
                    <span class="label-text">记住密码</span>
                </label>
            </div>
            <button class="btn btn-primary" :disabled="loading || !certPem" @click="submit()">
                <span class="loading loading-spinner" x-show="loading"></span>
                导入
            </button>
            <div class="alert alert-success" x-show="successMsg" x-text="successMsg"></div>
            <div class="alert alert-error" x-show="errorMsg" x-text="errorMsg"></div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
function importCertPage() {
    return {
        certPem: '',
        keyPem: '',
        keyPassword: '',
        rememberPassword: false,
        loading: false,
        successMsg: '',
        errorMsg: '',
        async submit() {
            this.loading = true;
            this.successMsg = '';
            this.errorMsg = '';
            const resp = await apiFetch('/api/certificates/import', {
                method: 'POST',
                body: JSON.stringify({
                    cert_pem: this.certPem,
                    key_pem: this.keyPem || null,
                    key_password: this.keyPassword || null,
                    remember_password: this.rememberPassword,
                })
            });
            const payload = await resp.json();
            if (payload.success) {
                this.successMsg = `导入成功。证书 ID: ${payload.data.certificate_id}`;
                notifySuccess(this.successMsg);
            } else {
                this.errorMsg = payload.message || payload.error?.detail || '导入失败';
                notifyError(this.errorMsg);
            }
            this.loading = false;
        }
    }
}
</script>
{% endblock %}
