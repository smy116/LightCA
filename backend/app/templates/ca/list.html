{% extends "base.html" %}

{% block title %}CA 管理 - LightCA{% endblock %}

{% block content %}
<section x-data="caPage()" x-init="load()" class="space-y-4">
    <div class="flex flex-wrap items-center justify-between gap-3">
        <h1 class="text-3xl font-bold">证书颁发机构</h1>
        <a href="/certificates/sign" class="btn btn-primary">创建 CA</a>
    </div>

    <div class="grid gap-4 sm:grid-cols-2 xl:grid-cols-3">
        <template x-for="ca in cas" :key="ca.id">
            <article class="card bg-base-100 shadow-sm border border-base-300">
                <div class="card-body">
                    <div class="flex items-center justify-between">
                        <h2 class="card-title" x-text="ca.subject_cn"></h2>
                        <span class="badge" :class="statusBadgeClass(ca.status)" x-text="certificateStatusLabel(ca.status)"></span>
                    </div>
                    <p class="text-sm opacity-70"><span x-text="certificateTypeLabel(ca.type)"></span> / ID <span x-text="ca.id"></span></p>
                    <p class="text-xs opacity-60" x-show="ca.parent_id">父 CA ID: <span x-text="ca.parent_id"></span></p>
                    <p class="text-xs font-mono opacity-70" x-text="ca.serial_number"></p>
                    <div class="card-actions justify-end">
                        <a class="btn btn-sm" :href="`/ca/detail?certificate_id=${ca.id}`">详情</a>
                        <button class="btn btn-sm btn-outline" @click="exportCa(ca.id)">导出</button>
                        <button class="btn btn-sm btn-outline btn-error" :disabled="deletingId === ca.id" @click="removeCa(ca.id)">
                            <span class="loading loading-spinner loading-xs" x-show="deletingId === ca.id"></span>
                            删除
                        </button>
                    </div>
                </div>
            </article>
        </template>
    </div>

    <div class="alert alert-error" x-show="errorMsg" x-text="errorMsg"></div>
</section>
{% endblock %}

{% block scripts %}
<script>
window.caPage = () => {
    return {
        cas: [],
        deletingId: null,
        errorMsg: '',
        async load() {
            this.errorMsg = '';
            const [rootResp, intermediateResp] = await Promise.all([
                apiFetch('/api/certificates/list?cert_type=root&per_page=100'),
                apiFetch('/api/certificates/list?cert_type=intermediate&per_page=100'),
            ]);
            const rootPayload = await rootResp.json();
            const intermediatePayload = await intermediateResp.json();

            if (!rootPayload.success || !intermediatePayload.success) {
                this.cas = [];
                this.errorMsg = '加载 CA 列表失败。';
                notifyError(this.errorMsg);
                return;
            }

            const roots = rootPayload.data.certificates || [];
            const intermediates = intermediatePayload.data.certificates || [];
            this.cas = [...roots, ...intermediates];
        },
        async exportCa(id) {
            try {
                await downloadWithAuth(`/api/certificates/export?certificate_id=${id}&format=pem`);
                notifySuccess('CA 证书已导出');
            } catch (error) {
                notifyError(error.message || '导出失败');
            }
        },
        async removeCa(id) {
            if (!await confirmAction('确定要删除此 CA 证书吗？', { confirmClass: 'btn-error' })) return;
            const deleteKey = await confirmAction('是否同时删除关联私钥？\n确定=同时删除，取消=仅删除证书', {
                title: '关联私钥处理',
                confirmText: '同时删除私钥',
                cancelText: '仅删除证书',
                confirmClass: 'btn-error',
            });
            this.deletingId = id;
            const resp = await apiFetch('/api/certificates/delete', {
                method: 'POST',
                body: JSON.stringify({ certificate_id: id, delete_key: deleteKey })
            });
            const payload = await resp.json();
            if (payload.success) {
                notifySuccess('CA 证书已删除');
                await this.load();
            } else {
                notifyError(payload.message || payload.error?.detail || '删除失败');
            }
            this.deletingId = null;
        }
    }
}
</script>
{% endblock %}
