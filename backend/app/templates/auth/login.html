<!DOCTYPE html>
<html lang="zh-CN" data-theme="winter">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>登录 - LightCA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script defer src="/static/js/api.js"></script>
  <script defer src="/static/js/app.js"></script>
</head>
<body class="min-h-screen bg-base-200">
  <main class="min-h-screen grid place-items-center p-4">
    <section class="card w-full max-w-md bg-base-100 shadow-xl border border-base-300">
      <div class="card-body gap-4">
        <h1 class="card-title text-2xl">
          <i class="ph ph-certificate text-lightca-600"></i>
          LightCA 登录
        </h1>
        <p class="text-sm opacity-70">使用管理员凭据登录以管理证书和密钥。</p>

        <label class="form-control w-full">
          <div class="label"><span class="label-text">用户名</span></div>
          <input id="username" class="input input-bordered w-full" value="admin" autocomplete="username" />
        </label>

        <label class="form-control w-full">
          <div class="label"><span class="label-text">密码</span></div>
          <input id="password" type="password" class="input input-bordered w-full" autocomplete="current-password" />
        </label>

        <button id="submit-btn" class="btn btn-primary" type="button">
          <span id="loading" class="loading loading-spinner hidden"></span>
          登录
        </button>

        <div id="error-box" class="alert alert-error hidden"></div>
      </div>
    </section>
  </main>

  <script>
    document.documentElement.setAttribute("data-theme", (window.LightCAApp && window.LightCAApp.getTheme()) || "winter");
    const btn = document.getElementById("submit-btn");
    const spinner = document.getElementById("loading");
    const errorBox = document.getElementById("error-box");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");

    function setLoading(flag) {
      btn.disabled = flag;
      spinner.classList.toggle("hidden", !flag);
    }

    async function submitLogin() {
      const username = usernameInput.value.trim();
      const password = passwordInput.value;
      errorBox.classList.add("hidden");
      setLoading(true);

      try {
        const response = await fetch("/api/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });

        const payload = await response.json();
        if (!response.ok) {
          throw new Error(payload.message || payload.detail || "登录失败");
        }

        if (window.LightCAApi) {
          window.LightCAApi.setAuthToken(payload.token);
        }
        window.location.href = "/";
      } catch (error) {
        errorBox.textContent = error.message || "登录失败";
        errorBox.classList.remove("hidden");
      } finally {
        setLoading(false);
      }
    }

    btn.addEventListener("click", submitLogin);
    passwordInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        submitLogin();
      }
    });
  </script>
</body>
</html>
